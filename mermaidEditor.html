<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Mermaid Chart Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dagre/0.8.5/dagre.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col h-screen">

    <main class="flex-1 flex flex-col md:flex-row p-4 gap-4 overflow-hidden relative">
        
        <div class="flex-1 flex flex-col bg-white rounded-lg shadow-md overflow-hidden">
            <div class="p-2 bg-gray-100 border-b flex items-center justify-between text-sm text-gray-600">
                <div class="flex items-center gap-2">
                    <button id="load-chart-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-gray-200 hover:bg-gray-300 shadow-sm" title="Load Chart from Code">
                        <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 002 2z"></path></svg>
                    </button>
                    
                    <!-- Diagram Type Selector -->
                    <div class="flex items-center gap-2 ml-4">
                        <label for="diagram-type-selector" class="text-sm font-medium text-gray-700">Diagram Type:</label>
                        <select id="diagram-type-selector" class="px-3 py-1 border border-gray-300 rounded-md bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="flowchart">Flowchart</option>
                            <option value="sequenceDiagram">Sequence Diagram</option>
                            <option value="classDiagram">Class Diagram</option>
                            <option value="erDiagram">Entity Relationship</option>
                            <option value="gantt">Gantt Chart</option>
                            <option value="journey">User Journey</option>
                        </select>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <!-- Save/Load Project Buttons -->
                    <div class="flex items-center gap-1 mr-2">
                        <button id="save-project-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 shadow-sm text-xs" title="Save Project">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Save
                        </button>
                        <button id="load-project-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm text-xs" title="Load Project">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                            </svg>
                            Load
                        </button>
                    </div>
                    
                    <!-- Divider -->
                    <div class="border-l border-gray-300 h-6 mx-1"></div>
                    
                    <!-- Export Buttons -->
                    <button id="export-png-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 shadow-sm text-xs" title="Export as PNG">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        PNG
                    </button>
                    <button id="export-svg-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-green-600 text-white hover:bg-green-700 shadow-sm text-xs" title="Export as SVG">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        SVG
                    </button>
                    <button id="export-pdf-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow-sm text-xs" title="Export as PDF">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        PDF
                    </button>
                    
                    <!-- Divider -->
                    <div class="border-l border-gray-300 h-6 mx-1"></div>
                    
                    <!-- Layers Button -->
                    <button id="layers-btn" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 shadow-sm text-xs" title="Show Layers Panel (Ctrl+L)">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                        </svg>
                        Layers
                    </button>
                    
                    <!-- Divider -->
                    <div class="border-l border-gray-300 h-6 mx-1"></div>
                    
                    <!-- Grid and Snap Controls -->
                    <button id="toggle-grid" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 shadow-sm text-xs active" title="Toggle Grid">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        Grid
                    </button>
                    <button id="toggle-snap" class="tool-btn flex items-center justify-center p-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 shadow-sm text-xs active" title="Toggle Snap to Grid">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 012-2h2M4 16v2a2 2 0 002 2h2M16 4h2a2 2 0 012 2v2M16 20h2a2 2 0 002-2v-2"></path>
                        </svg>
                        Snap
                    </button>
                </div>
            </div>
            <div class="flex-1 relative" id="canvas-wrapper">
                <!-- Rulers -->
                <div id="ruler-corner" class="ruler-corner"></div>
                <div id="ruler-horizontal" class="ruler ruler-horizontal"></div>
                <div id="ruler-vertical" class="ruler ruler-vertical"></div>
                
                <!-- Canvas positioned to account for rulers -->
                <div class="absolute top-[30px] left-[30px] right-0 bottom-0">
                    <canvas id="canvas"></canvas>
                </div>
                
                <div id="zoom-controls" class="absolute bottom-4 right-4 bg-white bg-opacity-80 backdrop-blur-sm rounded-lg shadow-md p-2 flex items-center gap-2">
                    <button id="zoom-out-btn" class="tool-btn p-1 rounded-md w-8 h-8 font-bold" title="Zoom Out">-</button>
                    <span id="zoom-level" class="text-sm font-medium text-gray-700 w-12 text-center">100%</span>
                    <button id="zoom-in-btn" class="tool-btn p-1 rounded-md w-8 h-8 font-bold" title="Zoom In">+</button>
                    <button id="zoom-reset-btn" class="tool-btn p-2 rounded-md text-sm" title="Reset Zoom">Reset</button>
                </div>
            </div>
        </div>

        
        <!-- Alignment Toolbar -->
        <div id="alignment-toolbar" class="alignment-toolbar">
            <button class="alignment-btn" data-align="left" title="Align Left">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="17" y1="10" x2="3" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="17" y1="18" x2="3" y2="18"></line>
                </svg>
            </button>
            <button class="alignment-btn" data-align="center" title="Align Center">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="10" x2="6" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="18" y1="18" x2="6" y2="18"></line>
                </svg>
            </button>
            <button class="alignment-btn" data-align="right" title="Align Right">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="21" y1="10" x2="7" y2="10"></line>
                    <line x1="21" y1="6" x2="3" y2="6"></line>
                    <line x1="21" y1="14" x2="3" y2="14"></line>
                    <line x1="21" y1="18" x2="7" y2="18"></line>
                </svg>
            </button>
            <button class="alignment-btn" data-align="top" title="Align Top">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="10" y1="17" x2="10" y2="3"></line>
                    <line x1="6" y1="21" x2="6" y2="3"></line>
                    <line x1="14" y1="21" x2="14" y2="3"></line>
                    <line x1="18" y1="17" x2="18" y2="3"></line>
                </svg>
            </button>
            <button class="alignment-btn" data-align="middle" title="Align Middle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="10" y1="18" x2="10" y2="6"></line>
                    <line x1="6" y1="21" x2="6" y2="3"></line>
                    <line x1="14" y1="21" x2="14" y2="3"></line>
                    <line x1="18" y1="18" x2="18" y2="6"></line>
                </svg>
            </button>
            <button class="alignment-btn" data-align="bottom" title="Align Bottom">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="10" y1="21" x2="10" y2="7"></line>
                    <line x1="6" y1="21" x2="6" y2="3"></line>
                    <line x1="14" y1="21" x2="14" y2="3"></line>
                    <line x1="18" y1="21" x2="18" y2="7"></line>
                </svg>
            </button>
            <button class="alignment-btn" data-align="distribute" title="Distribute Horizontally">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="4" y1="21" x2="4" y2="3"></line>
                    <line x1="9" y1="21" x2="9" y2="3"></line>
                    <line x1="15" y1="21" x2="15" y2="3"></line>
                    <line x1="20" y1="21" x2="20" y2="3"></line>
                </svg>
            </button>
        </div>
        
        <!-- Bulk Editing Panel -->
        <div id="bulk-editing-panel" class="fixed top-20 right-4 bg-white border border-gray-300 rounded-lg shadow-lg p-4 z-30" style="display: none;">
            <h3 class="text-sm font-medium text-gray-900 mb-3">Bulk Edit Selection</h3>
            <div class="space-y-3">
                <div>
                    <label for="bulk-fill-color" class="block text-xs font-medium text-gray-700 mb-1">Fill Color</label>
                    <input type="color" id="bulk-fill-color" class="w-full h-8" value="#ffffff">
                </div>
                <div>
                    <label for="bulk-stroke-color" class="block text-xs font-medium text-gray-700 mb-1">Stroke Color</label>
                    <input type="color" id="bulk-stroke-color" class="w-full h-8" value="#222222">
                </div>
            </div>
        </div>

        <div id="tool-palette" class="absolute top-1/2 left-4 -translate-y-1/2 z-20 bg-white bg-opacity-80 backdrop-blur-sm rounded-lg shadow-lg p-1 flex flex-col items-center gap-1 draggable" style="width: 44px;">
            <!-- Always visible tools -->
            <button data-mode="select" class="tool-btn p-1.5 rounded-md active w-8 h-8 flex items-center justify-center" title="Select / Pan Tool">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13,6V11H18V7.75L22.25,12L18,16.25V13H13V18H16.25L12,22.25L7.75,18H11V13H6V16.25L1.75,12L6,7.75V11H11V6H7.75L12,1.75L16.25,6H13Z" /></svg>
            </button>
            
            
            <!-- Flowchart tools -->
            <div id="flowchart-tools" class="tool-group flex flex-col items-center gap-1">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-rect" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Rectangle">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v16H4z"></path></svg>
                </button>
                <button data-mode="add-rounded" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Rounded Rectangle">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z"></path></svg>
                </button>
                <button data-mode="add-circle" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Circle">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2z"></path></svg>
                </button>
                <button data-mode="add-diamond" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Diamond">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2L2 12l10 10 10-10L12 2z"></path></svg>
                </button>
                <button data-mode="add-text" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Text">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M21 11H3v2h18v-2zm-2-4H5v2h14V7zM3 15h18v2H3v-2z"></path></svg>
                </button>
                <button data-mode="add-subgraph" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Subgraph">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3zM3 9h18"></path></svg>
                </button>
            </div>
            
            <!-- Markdown tool (always visible) -->
            <div id="markdown-tool" class="tool-group flex flex-col items-center gap-1">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-markdown" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Markdown Box">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.5 4H3.5A1.5 1.5 0 0 0 2 5.5v13A1.5 1.5 0 0 0 3.5 20h17a1.5 1.5 0 0 0 1.5-1.5v-13A1.5 1.5 0 0 0 20.5 4zM7 16H5V8h2v8zm5 0h-2V8h2v8zm5 0h-2V8h2v8z"></path></svg>
                </button>
            </div>
            
            <!-- Sequence diagram tools -->
            <div id="sequence-tools" class="tool-group hidden flex-col items-center gap-1" style="display: none;">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-actor" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Actor">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                </button>
                <button data-mode="add-message" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Message">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-3.582 8-8 8a8.955 8.955 0 01-4.126-.98L3 21l1.98-5.874A8.955 8.955 0 013 12c0-4.418 3.582-8 8-8s8 3.582 8 8z"></path></svg>
                </button>
                <button data-mode="add-note" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Note">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                </button>
            </div>
            
            <!-- Class diagram tools -->
            <div id="class-tools" class="tool-group hidden flex-col items-center gap-1" style="display: none;">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-class" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Class">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </button>
            </div>
            
            <!-- ER diagram tools -->
            <div id="er-tools" class="tool-group hidden flex-col items-center gap-1" style="display: none;">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-entity" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Entity">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v16H4z"></path></svg>
                </button>
                <button data-mode="add-attribute" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Attribute">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2z"></path></svg>
                </button>
            </div>
            
            <!-- Gantt diagram tools -->
            <div id="gantt-tools" class="tool-group hidden flex-col items-center gap-1" style="display: none;">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-task" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Task">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                </button>
                <button data-mode="add-milestone" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Milestone">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 12l10 10 10-10L12 2z"></path></svg>
                </button>
            </div>
            
            <!-- Journey diagram tools -->
            <div id="journey-tools" class="tool-group hidden flex-col items-center gap-1" style="display: none;">
                <div class="border-t w-6 my-0.5"></div>
                <button data-mode="add-step" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Journey Step">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path></svg>
                </button>
                <button data-mode="add-section" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Add Section">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                </button>
            </div>
            
            <!-- Connector tool (shared by all) -->
            <div class="border-t w-6 my-0.5"></div>
            <button data-mode="connector" class="tool-btn p-1.5 rounded-md w-8 h-8 flex items-center justify-center" title="Connector Tool">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
            </button>
        </div>
        
        <!-- Mobile Panel Toggle -->
        <button id="mobile-panel-toggle" class="md:hidden fixed top-4 right-4 z-30 bg-indigo-600 text-white p-2 rounded-full shadow-lg" title="Toggle Panel">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        
        <div id="right-panel" class="w-full md:w-1/3 flex flex-col flex-shrink-0 bg-white rounded-lg shadow-md overflow-hidden">
            <div class="flex border-b border-gray-200 flex-shrink-0">
                <button id="properties-tab" data-target="properties-pane" class="tab-btn" disabled>Properties</button>
                <button id="code-tab" data-target="code-pane" class="tab-btn">Code</button>
                <button id="preview-tab" data-target="preview-pane" class="tab-btn active">Preview</button>
            </div>
            
            <div class="flex-1 p-4 overflow-auto">
                <div id="properties-pane" class="tab-pane">
                    <div class="w-full space-y-4">
                        <div id="shape-properties" class="hidden space-y-4">
                            <h3 class="font-bold text-gray-700 border-b pb-1">Shape Properties</h3>
                            <div>
                                <label for="object-name" class="block text-sm font-medium text-gray-700 mb-1">Object Name (ID)</label>
                                <input type="text" id="object-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div>
                                <label for="object-text" class="block text-sm font-medium text-gray-700 mb-1">Display Text</label>
                                <input type="text" id="object-text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div>
                                <label for="fill-color" class="block text-sm font-medium text-gray-700 mb-1">Fill Color</label>
                                <input type="color" id="fill-color" class="mt-1 block w-full">
                            </div>
                            <div>
                                <label for="stroke-color" class="block text-sm font-medium text-gray-700 mb-1">Stroke Color</label>
                                <input type="color" id="stroke-color" class="mt-1 block w-full">
                            </div>
                            <div>
                                <label for="stroke-width" class="block text-sm font-medium text-gray-700">Stroke Width</label>
                                <input type="number" id="stroke-width" min="0" max="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div id="corner-radius-control" class="hidden">
                                <label for="corner-radius" class="block text-sm font-medium text-gray-700">Corner Radius</label>
                                <input type="range" id="corner-radius" min="0" max="50" class="mt-1 block w-full">
                            </div>
                        </div>
                        <div id="text-properties" class="hidden space-y-4">
                            <h3 class="font-bold text-gray-700 border-b pb-1">Text Properties</h3>
                            <div id="text-object-info" class="hidden">
                                <label for="text-object-name" class="block text-sm font-medium text-gray-700 mb-1">Object Name (ID)</label>
                                <input type="text" id="text-object-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div id="text-content-info" class="hidden">
                                <label for="text-content" class="block text-sm font-medium text-gray-700 mb-1">Text Content</label>
                                <input type="text" id="text-content" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div>
                                <label for="text-color" class="block text-sm font-medium text-gray-700 mb-1">Text Color</label>
                                <input type="color" id="text-color" class="mt-1 block w-full">
                            </div>
                            <div>
                                <label for="font-size" class="block text-sm font-medium text-gray-700">Font Size</label>
                                <input type="number" id="font-size" min="8" max="120" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div>
                                <label for="font-family" class="block text-sm font-medium text-gray-700">Font Family</label>
                                <select id="font-family" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                                    <option>Kalam</option>
                                    <option>Comic Sans MS</option>
                                    <option>Inter</option>
                                    <option>Arial</option>
                                    <option>Helvetica</option>
                                    <option>Times New Roman</option>
                                    <option>Courier New</option>
                                    <option>Verdana</option>
                                </select>
                            </div>
                             <div class="flex items-center">
                                <input type="checkbox" id="font-bold" class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                                <label for="font-bold" class="ml-2 block text-sm text-gray-900">Bold</label>
                            </div>
                        </div>
                        <div id="subgraph-properties" class="hidden space-y-4">
                            <h3 class="font-bold text-gray-700 border-b pb-1">Subgraph Properties</h3>
                            <div>
                                <label for="subgraph-object-name" class="block text-sm font-medium text-gray-700 mb-1">Object Name (ID)</label>
                                <input type="text" id="subgraph-object-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div>
                                <label for="subgraph-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                                <input type="text" id="subgraph-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <div>
                                <label for="subgraph-fill-color" class="block text-sm font-medium text-gray-700 mb-1">Fill Color</label>
                                <input type="color" id="subgraph-fill-color" class="mt-1 block w-full">
                            </div>
                             <div>
                                <label for="subgraph-stroke-color" class="block text-sm font-medium text-gray-700 mb-1">Border Color</label>
                                <input type="color" id="subgraph-stroke-color" class="mt-1 block w-full">
                            </div>
                        </div>
                        <div id="connector-properties" class="hidden space-y-4">
                            <h3 class="font-bold text-gray-700 border-b pb-1">Connector Properties</h3>
                            <div>
                                <label for="connector-text" class="block text-sm font-medium text-gray-700 mb-1">Link Text</label>
                                <input type="text" id="connector-text" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-1">
                            </div>
                            <label class="block text-sm font-medium text-gray-700">Arrow Type</label>
                            <div id="arrow-type-control" class="space-y-2">
                                <label class="flex items-center"><input type="radio" name="arrow-type" value="-->" class="form-radio h-4 w-4 text-indigo-600"><span class="ml-2 text-gray-700">End Arrow (-->)</span></label>
                                <label class="flex items-center"><input type="radio" name="arrow-type" value="<--" class="form-radio h-4 w-4 text-indigo-600"><span class="ml-2 text-gray-700">Start Arrow (<--)</span></label>
                                <label class="flex items-center"><input type="radio" name="arrow-type" value="<-->" class="form-radio h-4 w-4 text-indigo-600"><span class="ml-2 text-gray-700">Both Arrows (<-->)</span></label>
                                <label class="flex items-center"><input type="radio" name="arrow-type" value="---" class="form-radio h-4 w-4 text-indigo-600"><span class="ml-2 text-gray-700">Line Only (---)</span></label>
                            </div>
                        </div>
                        <div id="layering-controls" class="hidden border-t pt-4 space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Layering</label>
                            <button id="bring-to-front" class="tool-btn w-full p-2 rounded-lg bg-white border border-gray-300 hover:bg-gray-100 text-sm">Bring to Front</button>
                            <button id="send-to-back" class="tool-btn w-full p-2 rounded-lg bg-white border border-gray-300 hover:bg-gray-100 text-sm">Send to Back</button>
                        </div>
                    </div>
                </div>
                <div id="code-pane" class="tab-pane flex-col">
                    <div class="bg-gray-900 text-white p-3 rounded-md font-mono text-sm flex-1 overflow-auto">
                        <pre><code id="mermaid-code"></code></pre>
                    </div>
                </div>
                <div id="preview-pane" class="tab-pane active items-center justify-center">
                     <div id="mermaid-preview" class="w-full h-full"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="text-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/3">
            <h3 class="text-lg font-bold mb-4">Edit Text</h3>
            <input type="text" id="text-input" class="w-full border border-gray-300 p-2 rounded-md">
            <div class="mt-4 flex justify-end gap-2">
                <button id="cancel-text" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="save-text" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Save</button>
            </div>
        </div>
    </div>
    
    <div id="load-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2">
            <h3 class="text-lg font-bold mb-4">Load from Mermaid Code</h3>
            <p class="text-sm text-gray-600 mb-4">Paste your Mermaid chart code below. The layout may not be perfectly preserved, but all nodes and connections will be loaded for you to edit.</p>
            <textarea id="mermaid-input" class="w-full h-64 border border-gray-300 p-2 rounded-md font-mono text-sm"></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button id="cancel-load" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="confirm-load" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Load Chart</button>
            </div>
        </div>
    </div>

    <!-- Save Project Modal -->
    <div id="save-project-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/3">
            <h3 class="text-lg font-bold mb-4">Save Project</h3>
            <div class="space-y-4">
                <div>
                    <label for="project-name" class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                    <input type="text" id="project-name" class="w-full border border-gray-300 p-2 rounded-md" placeholder="My Diagram">
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                    <div>
                        <div class="font-medium text-gray-900">Save Options</div>
                        <div class="text-sm text-gray-500">Choose where to save your project</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <button id="save-to-storage" class="w-full flex items-center justify-center p-3 border border-gray-300 rounded-md hover:bg-gray-50">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12l5 5L20 7"></path>
                        </svg>
                        Save to Browser Storage
                    </button>
                    <button id="save-to-file" class="w-full flex items-center justify-center p-3 border border-gray-300 rounded-md hover:bg-gray-50">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Download as File
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="cancel-save-project" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Project Modal -->
    <div id="load-project-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-1/2">
            <h3 class="text-lg font-bold mb-4">Load Project</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
                    <div>
                        <div class="font-medium text-gray-900">Load Options</div>
                        <div class="text-sm text-gray-500">Choose how to load your project</div>
                    </div>
                </div>
                <div class="space-y-2">
                    <button id="load-from-storage" class="w-full flex items-center justify-center p-3 border border-gray-300 rounded-md hover:bg-gray-50">
                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Load from Browser Storage
                    </button>
                    <button id="load-from-file" class="w-full flex items-center justify-center p-3 border border-gray-300 rounded-md hover:bg-gray-50">
                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Upload from File
                    </button>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="cancel-load-project" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Saved Projects Modal -->
    <div id="saved-projects-modal" class="modal-overlay hidden">
        <div class="modal-content w-11/12 md:w-2/3">
            <h3 class="text-lg font-bold mb-4">Saved Projects</h3>
            <div id="saved-projects-list" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                <!-- Projects will be dynamically populated -->
            </div>
            <div class="flex justify-end gap-2">
                <button id="cancel-saved-projects" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for file uploads -->
    <input type="file" id="file-input" accept=".json" style="display: none;">

    <!-- Layers Panel -->
    <div id="layers-panel" class="layers-panel">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-gray-800">Layers</h3>
            <button id="close-layers-panel" class="text-gray-500 hover:text-gray-700">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <ul id="layers-list" class="space-y-1 mb-3">
            <!-- Layers will be dynamically populated here -->
        </ul>
        <button id="add-layer-btn" class="add-layer-btn">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            Add Layer
        </button>
    </div>
    <script src="js/app.js" type="module"></script>
    <div id="markdown-editor" class="hidden absolute bg-white border border-gray-300 rounded-lg shadow-lg p-2" style="z-index: 100;">
        <div id="markdown-toolbar" class="flex items-center border-b pb-1 mb-1">
            <button class="p-1 hover:bg-gray-200 rounded" data-command="bold" title="Bold"><b>B</b></button>
            <button class="p-1 hover:bg-gray-200 rounded" data-command="italic" title="Italic"><i>I</i></button>
            <button class="p-1 hover:bg-gray-200 rounded" data-command="underline" title="Underline"><u>U</u></button>
            <button class="p-1 hover:bg-gray-200 rounded" data-command="insertUnorderedList" title="Bullet List">&bull;</button>
            <button class="p-1 hover:bg-gray-200 rounded" data-command="insertOrderedList" title="Numbered List">1.</button>
            <button class="p-1 hover:bg-gray-200 rounded" data-command="createLink" title="Link">&infin;</button>
            <button class="p-1 hover:bg-gray-200 rounded" data-command="toggle-view" title="Toggle View">M&darr;</button>
        </div>
        <div id="markdown-textarea" class="w-full h-full" contenteditable="true"></div>
    </div>
</body>
</html>
